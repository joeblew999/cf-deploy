name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PROD_URL: https://cf-deploy-example.gedw99.workers.dev

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install
      - run: bun run check

  deploy:
    if: github.ref == 'refs/heads/main'
    needs: test
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun run ci:build

      - name: Deploy + E2E
        if: env.CLOUDFLARE_API_TOKEN != ''
        run: bun run ci:deploy && bun run ci:e2e

      - if: env.CLOUDFLARE_API_TOKEN == ''
        run: echo "::notice::Skipping deploy — CLOUDFLARE_API_TOKEN not set"

  preview:
    if: github.event_name == 'pull_request'
    needs: test
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun run ci:build

      - name: Upload PR preview
        if: env.CLOUDFLARE_API_TOKEN != ''
        id: preview
        working-directory: example
        run: |
          bun ../dist/cf-deploy.js upload --pr ${{ github.event.pull_request.number }}
          echo "url=https://pr-${{ github.event.pull_request.number }}-cf-deploy-example.gedw99.workers.dev" >> "$GITHUB_OUTPUT"

      - name: Smoke + E2E
        if: env.CLOUDFLARE_API_TOKEN != ''
        env:
          PROD_URL: ${{ steps.preview.outputs.url }}
        run: |
          cd example && bun ../dist/cf-deploy.js smoke $PROD_URL
          bun run ci:e2e

      - if: env.CLOUDFLARE_API_TOKEN == ''
        run: echo "::notice::Skipping PR preview — CLOUDFLARE_API_TOKEN not set"

      - name: Comment preview URL
        if: env.CLOUDFLARE_API_TOKEN != ''
        uses: actions/github-script@v7
        with:
          script: |
            const url = `${{ steps.preview.outputs.url }}`;
            const sha = context.sha.slice(0, 7);
            const body = [
              `### Preview deployed`,
              ``,
              `| | |`,
              `|---|---|`,
              `| **URL** | ${url} |`,
              `| **Commit** | [\`${sha}\`](${context.payload.pull_request.head.repo.html_url}/commit/${context.sha}) |`,
            ].join('\n');
            const { data: comments } = await github.rest.issues.listComments({
              ...context.repo, issue_number: context.payload.pull_request.number
            });
            const existing = comments.find(c => c.body?.includes('Preview deployed'));
            if (existing) {
              await github.rest.issues.updateComment({
                ...context.repo, comment_id: existing.id, body
              });
            } else {
              await github.rest.issues.createComment({
                ...context.repo, issue_number: context.payload.pull_request.number, body
              });
            }
