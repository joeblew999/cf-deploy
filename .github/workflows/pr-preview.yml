name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - name: Install deps
        run: cd example && bun install

      - name: Upload PR preview
        working-directory: example
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: bun ../bin/cf-deploy.ts preview --pr ${{ github.event.pull_request.number }}

      - name: Smoke test PR preview
        working-directory: example
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          PREVIEW_URL="https://pr-${{ github.event.pull_request.number }}-cf-deploy-example.gedw99.workers.dev"
          bun ../bin/cf-deploy.ts smoke "$PREVIEW_URL"

      - name: Playwright tests against PR preview
        working-directory: example
        run: |
          PREVIEW_URL="https://pr-${{ github.event.pull_request.number }}-cf-deploy-example.gedw99.workers.dev"
          bun x playwright install --with-deps chromium
          bun ../bin/cf-deploy.ts test "$PREVIEW_URL"

      - name: Comment preview URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNum = context.payload.pull_request.number;
            const url = `https://pr-${prNum}-cf-deploy-example.gedw99.workers.dev`;
            const body = `### Preview deployed\n\n${url}\n\nSmoke tests and Playwright tests passed.`;
            // Update or create comment
            const { data: comments } = await github.rest.issues.listComments({
              ...context.repo, issue_number: prNum
            });
            const existing = comments.find(c => c.body?.includes('Preview deployed'));
            if (existing) {
              await github.rest.issues.updateComment({
                ...context.repo, comment_id: existing.id, body
              });
            } else {
              await github.rest.issues.createComment({
                ...context.repo, issue_number: prNum, body
              });
            }
