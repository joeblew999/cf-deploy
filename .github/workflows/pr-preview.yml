name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - name: Install deps
        run: cd example && bun install

      - name: Build cf-deploy binary
        run: |
          bun install
          npm run build
          chmod +x cf-deploy
          echo "$(pwd)" >> $GITHUB_PATH

      - name: Upload PR preview
        if: env.CLOUDFLARE_API_TOKEN != ''
        id: preview
        working-directory: example
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          cf-deploy preview --pr ${{ github.event.pull_request.number }}
          echo "url=https://pr-${{ github.event.pull_request.number }}-cf-deploy-example.gedw99.workers.dev" >> "$GITHUB_OUTPUT"

      - name: Smoke test PR preview
        if: env.CLOUDFLARE_API_TOKEN != ''
        working-directory: example
        run: cf-deploy smoke "${{ steps.preview.outputs.url }}"

      - name: Playwright tests against PR preview
        if: env.CLOUDFLARE_API_TOKEN != ''
        working-directory: example
        run: |
          bun x playwright install --with-deps chromium
          cf-deploy test "${{ steps.preview.outputs.url }}"

      - name: Inform missing token
        if: env.CLOUDFLARE_API_TOKEN == ''
        run: echo "Skipping PR preview because CLOUDFLARE_API_TOKEN is not set."

      - name: Comment preview URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNum = context.payload.pull_request.number;
            const url = `${{ steps.preview.outputs.url }}`;
            const sha = context.sha.slice(0, 7);
            const body = [
              `### Preview deployed`,
              ``,
              `| | |`,
              `|---|---|`,
              `| **URL** | ${url} |`,
              `| **Commit** | [\`${sha}\`](${context.payload.pull_request.head.repo.html_url}/commit/${context.sha}) |`,
              `| **Status** | Smoke tests and Playwright tests passed |`,
            ].join('\n');
            const { data: comments } = await github.rest.issues.listComments({
              ...context.repo, issue_number: prNum
            });
            const existing = comments.find(c => c.body?.includes('Preview deployed'));
            if (existing) {
              await github.rest.issues.updateComment({
                ...context.repo, comment_id: existing.id, body
              });
            } else {
              await github.rest.issues.createComment({
                ...context.repo, issue_number: prNum, body
              });
            }
