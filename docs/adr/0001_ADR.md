# ADR: cf-deploy — Reusable Cloudflare Workers Deploy Toolkit

**Status**: Implemented
**Date**: 2026-02-24

## Problem

Deploying Cloudflare Workers with versioned releases, smoke tests, PR previews, and a version picker UI is a repeating pattern across projects. The logic was originally embedded in go-task infrastructure, which forces every consumer to use go-task.

## Decision

A standalone **Bun CLI toolkit** that wraps wrangler with versioning conventions. Any task runner can call it — task, make, just, npm scripts, shell, or nothing.

## Three Layers

| Layer                  | When                    | Where      | What                                                     |
| ---------------------- | ----------------------- | ---------- | -------------------------------------------------------- |
| **Dev-time CLI**       | Developer runs commands | Local / CI | `cf-deploy upload`, `promote`, `rollback`, `smoke`       |
| **Build-time codegen** | Deploy pipeline         | Local / CI | `cf-deploy versions-json` — manifest from wrangler + git |
| **Runtime component**  | Page load               | Browser    | `<cf-version-picker>` — vanilla Web Component, zero deps |

## Key Design Decisions

1. **Bun, not Node** — runs TypeScript natively, fast startup, already in stack
2. **Config file** — `cf-deploy.yml` is self-documenting, checked into git. Env vars as overrides.
3. **Standalone Binary (ADR 0002)** — Distributed as a compiled binary via GitHub Releases. No source code management or Bun required for consumers.
4. **Vanilla Web Component** — zero dependencies, light DOM, works with any CSS framework
5. **CLI, not library** — `cf-deploy upload` is the interface. Internals can change freely.
6. **Static manifest** — `versions.json` generated at dev time, embedded as static asset. Zero runtime Cloudflare API calls.
7. **Git metadata preserved** — each version stores commit hash, message, branch, GitHub URL. Preserved across regenerations.
8. **Promote by tag** — `cf-deploy promote --version v1.2.0` promotes a specific version. Rollback promotes previous from manifest.

## Structure

```
cf-deploy/
  cf-deploy               Compiled standalone binary (built via bun build --compile)
  bin/cf-deploy.ts        CLI entry point
  lib/
    config.ts             Reads cf-deploy.yml (CWD-first search)
    # ...
```

## CLI Commands

```
cf-deploy deploy [--version X]        Upload + smoke test + preview URL
cf-deploy upload [--version X]        Tagged upload (auto-reads package.json)
cf-deploy promote [--version X]       Promote specific or latest to 100%
cf-deploy rollback                    Smart rollback using versions.json
cf-deploy smoke [URL]                 Health + index checks
cf-deploy versions-json               Generate manifest from wrangler + git
cf-deploy preview --pr N              PR preview upload
cf-deploy test [URL]                  Run Playwright tests against a URL
cf-deploy list                        Show all versions with URLs
cf-deploy status                      Current deployment info
cf-deploy delete [--yes]              Full worker teardown
cf-deploy whoami                      Cloudflare auth info
cf-deploy init --name N --domain D    Scaffold new project
```

## Consumer Integration

```sh
# Install binary
curl -sSL https://raw.githubusercontent.com/joeblew999/cf-deploy/main/install.sh | bash

# Use
cf-deploy upload
cf-deploy promote
```
