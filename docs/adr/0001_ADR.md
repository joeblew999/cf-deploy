# ADR: cf-deploy — Reusable Cloudflare Workers Deploy Toolkit

**Status**: Implemented
**Date**: 2026-02-24

## Problem

Deploying Cloudflare Workers with versioned releases, smoke tests, PR previews, and a version picker UI is a repeating pattern across projects. The logic was originally embedded in go-task infrastructure, which forces every consumer to use go-task.

## Decision

A standalone **Bun CLI toolkit** that wraps wrangler with versioning conventions. Any task runner can call it — task, make, just, npm scripts, shell, or nothing.

## Three Layers

| Layer                  | When                    | Where      | What                                                     |
| ---------------------- | ----------------------- | ---------- | -------------------------------------------------------- |
| **Dev-time CLI**       | Developer runs commands | Local / CI | `cf-deploy upload`, `promote`, `rollback`, `smoke`       |
| **Build-time codegen** | Deploy pipeline         | Local / CI | `cf-deploy versions-json` — manifest from wrangler API   |
| **Runtime component**  | Page load               | Browser    | `<cf-version-picker>` — vanilla Web Component, zero deps |

## Key Design Decisions

1. **Bun, not Node** — runs TypeScript natively, fast startup, already in stack
2. **No config file** — reads `wrangler.toml` for worker name and assets dir. Everything else via env vars or CLI flags.
3. **Distribution** — both a **Tiny JS Bundle** (for Bun users via `bunx`) and a **Standalone Binary** (for CI/non-Bun users)
4. **Vanilla Web Component** — zero dependencies, light DOM, works with any CSS framework
5. **CLI, not library** — `cf-deploy upload` is the interface. Internals can change freely.
6. **Static manifest** — `versions.json` generated BEFORE upload, embedded as static asset. Zero runtime Cloudflare API calls.
7. **APP_VERSION injected at upload time** — `wrangler versions upload --var APP_VERSION:X`. No hardcoded version strings. Health endpoint reads `env.APP_VERSION`.
8. **Promote by tag** — `cf-deploy promote --version v1.2.0` promotes a specific version. Rollback promotes previous from wrangler versions list.

## CLI Commands

```
cf-deploy upload [--version X] [--tag T] [--pr N]   Upload a new version
cf-deploy promote [--version X]                      Promote to 100% traffic
cf-deploy rollback                                   Revert to previous version
cf-deploy smoke <URL>                                Health + index check
cf-deploy versions-json [--out PATH]                 Generate versions manifest
cf-deploy init --name N [--domain D]                 Scaffold a new project
```

Global flags: `--dir PATH`, `--name NAME`, `--domain DOMAIN`

## Consumer Integration

```sh
# Option A: Bun (Preferred)
bunx cf-deploy upload

# Option B: Standalone Binary
curl -sSL https://raw.githubusercontent.com/joeblew999/cf-deploy/main/install.sh | bash
./cf-deploy upload
```
